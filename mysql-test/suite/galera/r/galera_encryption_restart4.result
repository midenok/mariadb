connection node_2;
connection node_1;
# node_1
CREATE TABLE encryption(a INT primary key, b text) engine=innodb;
INSERT into encryption values (1, 'VerySecretMessage');
NOT FOUND /CREATE TABLE encryption\(a INT\)/ in galera.page.00000*
NOT FOUND /CREATE TABLE encryption\(a INT\)/ in galera.cache
NOT FOUND /VerySecretMessage/ in galera.page.00000*
NOT FOUND /VerySecretMessage/ in galera.cache
connection node_2;
# node_2
show variables like 'encrypt_binlog';
Variable_name	Value
encrypt_binlog	ON
NOT FOUND /CREATE TABLE encryption\(a INT\)/ in galera.cache
NOT FOUND /VerySecretMessage/ in galera.page.00000*
NOT FOUND /VerySecretMessage/ in galera.cache
# Restart node 2 with key file that does not exists
connection node_2;
# node_2
call mtr.add_suppression("mysqld: File.*");
call mtr.add_suppression("Plugin 'file_key_management' init function returned error.");
call mtr.add_suppression("Plugin 'file_key_management' registration as a ENCRYPTION failed.");
show variables like 'encrypt_binlog';
Variable_name	Value
encrypt_binlog	ON
INSERT INTO encryption values (2, 'NotAnymoreSecret');
NOT FOUND /CREATE TABLE encryption\(a INT\)/ in galera.cache
NOT FOUND /VerySecretMessage/ in galera.page.00000*
FOUND 2 /VerySecretMessage/ in galera.cache
NOT FOUND /NotAnymoreSecret/ in galera.page.00000*
FOUND 2 /NotAnymoreSecret/ in galera.cache
connection node_1;
# node_1
NOT FOUND /CREATE TABLE encryption\(a INT\)/ in galera.page.00000*
NOT FOUND /CREATE TABLE encryption\(a INT\)/ in galera.cache
NOT FOUND /VerySecretMessage/ in galera.page.00000*
NOT FOUND /VerySecretMessage/ in galera.cache
NOT FOUND /NotAnymoreSecret/ in galera.page.00000*
NOT FOUND /NotAnymoreSecret/ in galera.cache
# Restart node 2 with correct existing key file
connection node_2;
# node_2
show variables like 'encrypt_binlog';
Variable_name	Value
encrypt_binlog	ON
INSERT INTO encryption values (3, 'AgainMoreSecret');
NOT FOUND /CREATE TABLE encryption\(a INT\)/ in galera.cache
NOT FOUND /VerySecretMessage/ in galera.page.00000*
FOUND 2 /VerySecretMessage/ in galera.cache
NOT FOUND /NotAnymoreSecret/ in galera.page.00000*
FOUND 2 /NotAnymoreSecret/ in galera.cache
NOT FOUND /AgainMoreSecret/ in galera.page.00000*
NOT FOUND /AgainMoreSecret/ in galera.cache
connection node_1;
DROP TABLE encryption;
