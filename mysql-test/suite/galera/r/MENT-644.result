connection node_2;
connection node_1;
connect node_1a, 127.0.0.1, root, , test, $NODE_MYPORT_1;
connect node_2a, 127.0.0.1, root, , test, $NODE_MYPORT_2;
connection node_1;
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY) ENGINE=InnoDB;
INSERT INTO t1 VALUES (1);
INSERT INTO t1 VALUES (2);
INSERT INTO t1 VALUES (3);
connection node_2;
SET GLOBAL debug_dbug = 'd,sync.wsrep_alter_locked_tables';
connection node_1;
SET DEBUG_SYNC = "alter_table_inplace_after_lock_downgrade SIGNAL downgraded WAIT_FOR continue";
SET SESSION wsrep_osu_method=NBO;
OPTIMIZE TABLE t1;
connection node_1a;
SET DEBUG_SYNC = "now WAIT_FOR downgraded";
connection node_2;
SET SESSION wsrep_sync_wait=0;
connection node_1a;
SET SESSION wsrep_retry_autocommit = 0;
INSERT INTO t1 VALUES (4);
connection node_2a;
SET SESSION wsrep_retry_autocommit = 0;
INSERT INTO t1 VALUES (5);
connection node_2;
SET GLOBAL debug_dbug = '';
SET DEBUG_SYNC= 'now SIGNAL signal.wsrep_alter_locked_tables';
SET DEBUG_SYNC = 'now WAIT_FOR signal.wsrep_alter_locked_tables_continued';
SET DEBUG_SYNC = 'RESET';
connection node_1a;
SET DEBUG_SYNC = "now SIGNAL continue";
connection node_1;
Table	Op	Msg_type	Msg_text
test.t1	optimize	note	Table does not support optimize, doing recreate + analyze instead
test.t1	optimize	status	OK
SELECT * FROM t1;
f1
1
2
3
4
5
connection node_2;
SELECT * FROM t1;
f1
1
2
3
4
5
connection node_1;
SET DEBUG_SYNC = 'RESET';
SET SESSION wsrep_osu_method=DEFAULT;
DROP TABLE t1;
