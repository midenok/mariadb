#
# Test NBO and a duplicate key error
#

--source include/galera_cluster.inc
--source include/have_innodb.inc

CREATE TABLE t1 (f1 INTEGER);
INSERT INTO t1 VALUES (1),(2),(3),(4),(5),(1);

--connection node_1
SET SESSION wsrep_OSU_method=NBO;

--error ER_DUP_ENTRY
ALTER TABLE t1 LOCK=SHARED, ADD PRIMARY KEY (f1);

INSERT INTO t1 VALUES (1);

SHOW CREATE TABLE t1;

--connection node_2
SHOW CREATE TABLE t1;
SELECT COUNT(*) =  7 FROM t1;

--connection node_1
ALTER IGNORE TABLE t1 LOCK=SHARED, ADD PRIMARY KEY (f1);

SELECT COUNT(*) = 5 FROM t1;

--connection node_2
SELECT COUNT(*) = 5 FROM t1;

SET SESSION wsrep_OSU_method=TOI;
DROP TABLE t1;

CALL mtr.add_suppression("WSREP: Event 1 Query apply failed: 1, seqno -1");
