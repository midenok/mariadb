--source suite/period/engines.inc

create or replace table t (id int, s date, e date, period for apptime(s,e));

insert into t values(1, '1999-01-01', '2018-12-12');
insert into t values(1, '1999-01-01', '2017-01-01');
insert into t values(1, '2017-01-01', '2019-01-01');
insert into t values(2, '1998-01-01', '2018-12-12');
insert into t values(3, '1997-01-01', '2015-01-01');
insert into t values(4, '2016-01-01', '2020-01-01');

create or replace table t1 (id int, s date, e date, period for apptime(s,e));
insert t1 select * from t;

--let $trig_cols=id, s, e
--let $trig_table=t1
--source suite/period/create_triggers.inc

delete from t for portion of apptime from '2000-01-01' to '2018-01-01';
delete from t1 for portion of APPTIME from '2000-01-01' to '2018-01-01';
select * from t;
select * from t1 order by id, s, e;
select * from log_tbl;

--echo # multi-table DELETE is prohibited
--error ER_PORTION_OF_TIME_NOT_ALLOWED
delete t, t1 from t for portion of apptime from '2000-01-01' to '2018-01-01', t1;


--error ER_PERIOD_NOT_FOUND
delete from t for portion of othertime from '2000-01-01' to '2018-01-01';
--error ER_PERIOD_SYSTEM_TIME_NOT_ALLOWED
delete from t for portion of system_time from '2000-01-01' to '2018-01-01';

create or replace table t (id int, str text, s date, e date,
    period for apptime(s,e));

insert into t values(1, 'data', '1999-01-01', '2018-12-12');
insert into t values(1, 'other data', '1999-01-01', '2018-12-12');
insert into t values(1, 'deleted', '2000-01-01', '2018-01-01');
delete from t for portion of apptime from '2000-01-01' to '2018-01-01';
show warnings;
select * from t;

drop table t1;

--echo # auto_inrement field is updated
create or replace table t (id int primary key auto_increment, s date, e date,
                           period for apptime(s, e));
insert into t values (default, '1999-01-01', '2018-12-12');
delete from t for portion of apptime from '2000-01-01' to '2018-01-01';
select * from t;
truncate t;
--echo # same for trigger case
insert into t values (default, '1999-01-01', '2018-12-12');
--let $trig_table=t
--source suite/period/create_triggers.inc

delete from t for portion of apptime from '2000-01-01' to '2018-01-01';
select * from t;
select * from log_tbl;

--echo # generated columns are updated
create or replace table t (s date, e date,
                           xs date as (s) stored, xe date as (e) stored,
                           period for apptime(s, e));
insert into t values('1999-01-01', '2018-12-12', default, default);
select * from t;
delete from t for portion of apptime from '2000-01-01' to '2018-01-01';
select * from t;
truncate t;
--echo # same for trigger case
insert into t values('1999-01-01', '2018-12-12', default, default);
--let $trig_table=t
--source suite/period/create_triggers.inc

delete from t for portion of apptime from '2000-01-01' to '2018-01-01';
select * from t;
select * from log_tbl;


--echo # system-time columns are updated
create or replace table t (s date, e date,
                           period for apptime(s, e)) with system versioning;
set @@timestamp=3141592;
insert into t values('1999-01-01', '2018-12-12');
insert into t values('1999-01-01', '1999-12-12');
select *, unix_timestamp(row_start), unix_timestamp(row_end) from t;
set @@timestamp=314159265.358979;
delete from t for portion of apptime from '2000-01-01' to '2018-01-01';
select *, unix_timestamp(row_start),
          unix_timestamp(row_end) from t order by row_end, s, e;

--echo # same for trigger case
delete from t;
delete history from t;
set @@timestamp=3141592;
insert into t values('1999-01-01', '2018-12-12');
insert into t values('1999-01-01', '1999-12-12');
select *, unix_timestamp(row_start), unix_timestamp(row_end) from t order by e;
--let $trig_table=t
--source suite/period/create_triggers.inc

set @@timestamp=314159265.358979;
delete from t for portion of apptime from '2000-01-01' to '2018-01-01';
select *, unix_timestamp(row_start),
          unix_timestamp(row_end) from t order by row_end, s, e;

select *, unix_timestamp(row_start),
          unix_timestamp(row_end) from t for system_time all
                                  order by row_end, s, e;
select * from log_tbl;

--echo # system versioning with transactions
create or replace table t (s date, e date,
    rs bigint(20) unsigned as row start invisible,
    re bigint(20) unsigned as row end invisible,
    period for apptime(s, e),
    period for system_time(rs, re)) with system versioning engine=InnoDB;
insert into t values('1999-01-01', '2018-12-12'),
                    ('1999-01-01', '1999-12-12');

select rs from t limit 1 into @ins_trx;
select re from t limit 1 into @trx_max;
select * from t;

delete from t for portion of apptime from '2000-01-01' to '2018-01-01';
select *, if(rs = @ins_trx, "OLD", "NEW"),
          if(re = @trx_max, "CURRENT", "HISTORY") from t for system_time all;

--echo # same for trigger case
delete from t;
delete history from t;
insert into t values('1999-01-01', '2018-12-12'),
                    ('1999-01-01', '1999-12-12');
--let $trig_table=t
--source suite/period/create_triggers.inc

select rs from t limit 1 into @ins_trx;
select * from t;

delete from t for portion of apptime from '2000-01-01' to '2018-01-01';
select *, if(rs = @ins_trx, "OLD", "NEW"),
          if(re = @trx_max, "CURRENT", "HISTORY") from t for system_time all;
select * from log_tbl;


create or replace database test;
