create or replace table log_tbl(log varchar(4));
create or replace procedure log(s varchar(4))
insert into log_tbl values(s);
create or replace table t (id int, s date, e date, period for apptime(s,e));
insert into t values(1, '1999-01-01', '2018-12-12');
insert into t values(1, '1999-01-01', '2017-01-01');
insert into t values(1, '2017-01-01', '2019-01-01');
insert into t values(2, '1998-01-01', '2018-12-12');
insert into t values(3, '1997-01-01', '2015-01-01');
insert into t values(4, '2016-01-01', '2020-01-01');
create or replace table t1 (id int, s date, e date, period for apptime(s,e));
insert t1 select * from t;
create trigger tr2upd before update on t1 for each row call log('>UPD');
create trigger tr1upd after  update on t1 for each row call log('<UPD');
create trigger tr2del before delete on t1 for each row call log('>DEL');
create trigger tr1del after  delete on t1 for each row call log('<DEL');
create trigger tr1ins before insert on t1 for each row call log('<INS');
create trigger tr2ins after  insert on t1 for each row call log('>INS');
delete from t for portion of apptime from '2000-01-01' to '2018-01-01';
delete from t1 for portion of APPTIME from '2000-01-01' to '2018-01-01';
select * from t;
id	s	e
1	1999-01-01	2000-01-01
1	1999-01-01	2000-01-01
1	2018-01-01	2019-01-01
2	1998-01-01	2000-01-01
3	1997-01-01	2000-01-01
4	2018-01-01	2020-01-01
1	2018-01-01	2018-12-12
2	2018-01-01	2018-12-12
select * from t1 order by id, s, e;
id	s	e
1	1999-01-01	2000-01-01
1	1999-01-01	2000-01-01
1	2018-01-01	2018-12-12
1	2018-01-01	2019-01-01
2	1998-01-01	2000-01-01
2	2018-01-01	2018-12-12
3	1997-01-01	2000-01-01
4	2018-01-01	2020-01-01
select * from log_tbl;
log
>DEL
<DEL
<INS
>INS
<INS
>INS
>DEL
<DEL
<INS
>INS
>DEL
<DEL
<INS
>INS
>DEL
<DEL
<INS
>INS
<INS
>INS
>DEL
<DEL
<INS
>INS
>DEL
<DEL
<INS
>INS
# multi-table DELETE is prohibited
delete t, t1 from t for portion of apptime from '2000-01-01' to '2018-01-01', t1;
ERROR HY000: PORTION OF TIME is not allowed here
delete from t for portion of othertime from '2000-01-01' to '2018-01-01';
ERROR HY000: PERIOD othertime is not found in table
delete from t for portion of system_time from '2000-01-01' to '2018-01-01';
ERROR HY000: PERIOD `SYSTEM_TIME` is not allowed here
create or replace table t (id int, str text, s date, e date,
period for apptime(s,e));
insert into t values(1, 'data', '1999-01-01', '2018-12-12');
insert into t values(1, 'other data', '1999-01-01', '2018-12-12');
insert into t values(1, 'deleted', '2000-01-01', '2018-01-01');
delete from t for portion of apptime from '2000-01-01' to '2018-01-01';
show warnings;
Level	Code	Message
select * from t;
id	str	s	e
1	data	1999-01-01	2000-01-01
1	other data	1999-01-01	2000-01-01
1	data	2018-01-01	2018-12-12
1	other data	2018-01-01	2018-12-12
drop table t1;
# auto_inrement field is updated
create or replace table t (id int primary key auto_increment, s date, e date,
period for apptime(s, e));
insert into t values (default, '1999-01-01', '2018-12-12');
delete from t for portion of apptime from '2000-01-01' to '2018-01-01';
select * from t;
id	s	e
2	1999-01-01	2000-01-01
3	2018-01-01	2018-12-12
truncate t;
# same for trigger case
insert into t values (default, '1999-01-01', '2018-12-12');
delete from t for portion of apptime from '2000-01-01' to '2018-01-01';
create trigger tr1ins before insert on t for each row call log('>INS');
select * from t;
id	s	e
2	1999-01-01	2000-01-01
3	2018-01-01	2018-12-12
# generated columns are updated
create or replace table t (s date, e date,
xs date as (s) stored, xe date as (e) stored,
period for apptime(s, e));
insert into t values('1999-01-01', '2018-12-12', default, default);
select * from t;
s	e	xs	xe
1999-01-01	2018-12-12	1999-01-01	2018-12-12
delete from t for portion of apptime from '2000-01-01' to '2018-01-01';
select * from t;
s	e	xs	xe
1999-01-01	2000-01-01	1999-01-01	2000-01-01
2018-01-01	2018-12-12	2018-01-01	2018-12-12
truncate t;
# same for trigger case
insert into t values('1999-01-01', '2018-12-12', default, default);
create trigger tr1ins before insert on t for each row call log('>INS');
delete from t for portion of apptime from '2000-01-01' to '2018-01-01';
select * from t;
s	e	xs	xe
1999-01-01	2000-01-01	1999-01-01	2000-01-01
2018-01-01	2018-12-12	2018-01-01	2018-12-12
# system-time columns are updated
create or replace table t (s date, e date,
period for apptime(s, e)) with system versioning;
set @@timestamp=3141592;
insert into t values('1999-01-01', '2018-12-12');
insert into t values('1999-01-01', '1999-12-12');
select *, unix_timestamp(row_start), unix_timestamp(row_end) from t;
s	e	unix_timestamp(row_start)	unix_timestamp(row_end)
1999-01-01	2018-12-12	3141592.000000	2147483647.999999
1999-01-01	1999-12-12	3141592.000000	2147483647.999999
set @@timestamp=314159265.358979;
delete from t for portion of apptime from '2000-01-01' to '2018-01-01';
select *, unix_timestamp(row_start), unix_timestamp(row_end) from t;
s	e	unix_timestamp(row_start)	unix_timestamp(row_end)
1999-01-01	2000-01-01	314159265.358979	2147483647.999999
1999-01-01	1999-12-12	3141592.000000	2147483647.999999
# same for trigger case
delete from t;
delete history from t;
set @@timestamp=3141592;
insert into t values('1999-01-01', '2018-12-12');
insert into t values('1999-01-01', '1999-12-12');
select *, unix_timestamp(row_start), unix_timestamp(row_end) from t;
s	e	unix_timestamp(row_start)	unix_timestamp(row_end)
1999-01-01	1999-12-12	3141592.000000	2147483647.999999
1999-01-01	2018-12-12	3141592.000000	2147483647.999999
set @@timestamp=314159265.358979;
delete from t for portion of apptime from '2000-01-01' to '2018-01-01';
select *, unix_timestamp(row_start), unix_timestamp(row_end) from t;
s	e	unix_timestamp(row_start)	unix_timestamp(row_end)
1999-01-01	1999-12-12	3141592.000000	2147483647.999999
1999-01-01	2000-01-01	314159265.358979	2147483647.999999
select *, unix_timestamp(row_start),
unix_timestamp(row_end) from t for system_time all;
s	e	unix_timestamp(row_start)	unix_timestamp(row_end)
1999-01-01	2018-12-12	3141592.000000	314159265.358979
1999-01-01	1999-12-12	3141592.000000	2147483647.999999
1999-01-01	2000-01-01	314159265.358979	2147483647.999999
create or replace database test;
