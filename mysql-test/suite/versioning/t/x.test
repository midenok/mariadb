--source include/have_partition.inc
--error ER_PART_WRONG_VALUE
create or replace table t1 (x int) with system versioning
partition by system_time limit 999 auto_increment;
--error ER_PART_WRONG_VALUE
create or replace table t1 (x int) with system versioning
partition by system_time interval 3599 second auto_increment;

create or replace table t1 (x int) with system versioning
partition by system_time limit 1000 auto_increment;
show create table t1;

insert into t1 values (1);
show create table t1;

--echo # Increment from 2 to 5
create or replace table t1 (x int) with system versioning
partition by system_time interval 3600 second
starts '2000-01-01 00:00:00' auto_increment;
show create table t1;

set timestamp= unix_timestamp('2000-01-01 00:00:00');
insert into t1 values (1);
show create table t1;

set timestamp= unix_timestamp('2000-01-01 01:00:00');
update t1 set x= x + 1;
show create table t1;

set timestamp= unix_timestamp('2000-01-01 02:00:00');
update t1 set x= x + 2;
show create table t1;

--echo # Increment from 3 to 6, manual names, LOCK TABLES
set timestamp= unix_timestamp('2000-01-01 00:00:00');
create or replace table t1 (x int) with system versioning
partition by system_time interval 1 hour auto_increment (
    partition p1 history,
    partition p3 history,
    partition pn current);
show create table t1;

insert into t1 values (1);
show create table t1;

set timestamp= unix_timestamp('2000-01-01 01:00:00');
update t1 set x= x + 3;
show create table t1;

set timestamp= unix_timestamp('2000-01-01 02:00:00');
update t1 set x= x + 4;
show create table t1;

lock tables t1 write;
set timestamp= unix_timestamp('2000-01-01 03:00:00');
update t1 set x= x + 5;
show create table t1;
unlock tables;

--echo # Test VIEW, LOCK TABLES
set timestamp= unix_timestamp('2000-01-01 00:00:00');
create or replace table t1 (x int) with system versioning
partition by system_time interval 1 hour auto_increment;
create or replace view v1 as select * from t1;

insert into v1 values (1);
show create table t1;

lock tables t1 write;
set timestamp= unix_timestamp('2000-01-01 01:00:00');
update t1 set x= x + 3;
show create table t1;
unlock tables;

drop view v1;
drop tables t1;

--echo # Multiple increments in single command
set timestamp= unix_timestamp('2000-01-01 00:00:00');
create or replace table t1 (x int) with system versioning
partition by system_time interval 1 hour auto_increment partitions 3;

create or replace table t2 (y int) with system versioning
partition by system_time interval 1 hour auto_increment partitions 4;

insert into t1 values (1);
insert into t2 values (2);

set timestamp= unix_timestamp('2000-01-01 01:00:00');
update t1, t2 set x= x + 1, y= y + 1;
show create table t1;
show create table t2;

set timestamp= unix_timestamp('2000-01-01 02:00:00');
update t1, t2 set x= x + 1, y= y + 1;
show create table t1;
show create table t2;

drop tables t1, t2;

--echo # PS, SP, LOCK TABLES
set timestamp= unix_timestamp('2000-01-01 00:00:00');
create or replace table t1 (x int) with system versioning
partition by system_time interval 1 hour auto_increment;

execute immediate 'insert into t1 values (1)';
show create table t1;

prepare s from 'update t1 set x= x + 6';
set timestamp= unix_timestamp('2000-01-01 01:00:00');
execute s; execute s;
show create table t1;

lock tables t1 write;
set timestamp= unix_timestamp('2000-01-01 02:00:00');
execute s; execute s;
show create table t1;
unlock tables;
drop prepare s;

create procedure sp() update t1 set x= x + 7;
set timestamp= unix_timestamp('2000-01-01 03:00:00');
call sp; call sp;
show create table t1;
lock tables t1 write;
set timestamp= unix_timestamp('2000-01-01 04:00:00');
call sp; call sp;
show create table t1;
unlock tables;
drop procedure sp;

--echo # Complex table
set timestamp= unix_timestamp('2000-01-01 00:00:00');
create or replace table t1 (
  x int primary key auto_increment,
  t timestamp(6) default '2001-11-11 11:11:11',
  b blob(4096) compressed null,
  c varchar(1033) character set utf8 not null,
  u int unique,
  m enum('a', 'b', 'c') not null default 'a' comment 'absolute',
  i1 tinyint, i2 smallint, i3 bigint,
  index three(i1, i2, i3),
  v1 timestamp(6) generated always as (t + interval 1 day),
  v2 timestamp(6) generated always as (t + interval 1 month) stored,
  s timestamp(6) as row start,
  e timestamp(6) as row end,
  period for system_time (s, e),
  ps date, pe date,
  period for app_time (ps, pe),
  constraint check_constr check (u > -1))
with system versioning default charset=ucs2
partition by system_time interval 1 hour auto_increment (
    partition p2 history,
    partition pn current);
show create table t1;

insert into t1 (x, c, u, i1, i2, i3, ps, pe)
values (1, 'cc', 0, 1, 2, 3, '1999-01-01', '2000-01-01');
show create table t1;

set timestamp= unix_timestamp('2000-01-01 01:00:00');
update t1 set x= x + 8;
show create table t1;

--echo # Concurrent DML
set timestamp= unix_timestamp('2000-01-01 00:00:00');
create or replace table t1 (x int) with system versioning
partition by system_time interval 1 hour auto_increment;

insert into t1 values (1);
show create table t1;

--connect con8, localhost, root
--connect con7, localhost, root
--connect con6, localhost, root
--connect con5, localhost, root
--connect con4, localhost, root
--connect con3, localhost, root
--connect con2, localhost, root
--connect con1, localhost, root
set timestamp= unix_timestamp('2000-01-01 01:00:00');
send update t1 set x= x + 10;
--connection con2
set timestamp= unix_timestamp('2000-01-01 02:00:00');
send update t1 set x= x + 20;
--connection con3
set timestamp= unix_timestamp('2000-01-01 03:00:00');
send update t1 set x= x + 30;
--connection con4
set timestamp= unix_timestamp('2000-01-01 04:00:00');
send update t1 set x= x + 40;
--connection con5
set timestamp= unix_timestamp('2000-01-01 05:00:00');
send update t1 set x= x + 50;
--connection con6
set timestamp= unix_timestamp('2000-01-01 06:00:00');
send update t1 set x= x + 60;
--connection con7
set timestamp= unix_timestamp('2000-01-01 07:00:00');
send update t1 set x= x + 70;
--connection con8
set timestamp= unix_timestamp('2000-01-01 08:00:00');
update t1 set x= x + 80;
--connection con1
reap;
--disconnect con1
--connection con2
reap;
--disconnect con2
--connection con3
reap;
--disconnect con3
--connection con4
reap;
--disconnect con4
--connection con5
reap;
--disconnect con5
--connection con6
reap;
--disconnect con6
--connection con7
reap;
--disconnect con7
--disconnect con8
--connection default
show create table t1;

drop tables t1;
