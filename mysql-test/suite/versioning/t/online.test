--source suite/versioning/innodb.inc
--source suite/versioning/common.inc

--disable_query_log
if ($MTR_COMBINATION_INPLACE)
{
    let $ALTER_TYPE= algorithm=inplace;
}
if ($MTR_COMBINATION_INSTANT)
{
    let $ALTER_TYPE= lock=none;
}
--enable_query_log


set system_versioning_alter_history=keep;

create or replace table t (a int);
--replace_result $ALTER_TYPE ALTER_TYPE
--error ER_ALTER_OPERATION_NOT_SUPPORTED_REASON, ER_ALTER_OPERATION_NOT_SUPPORTED_REASON
eval alter table t add system versioning, $ALTER_TYPE;
alter table t add system versioning, lock=shared;

--replace_result $ALTER_TYPE ALTER_TYPE
eval alter table t add column b int, change column a a int without system versioning, $ALTER_TYPE;
--replace_result $ALTER_TYPE ALTER_TYPE
eval alter table t drop system versioning, $ALTER_TYPE;

--replace_result $sys_datatype_expl SYS_DATATYPE
eval create or replace table t (
  a int, b int,
  row_start $sys_datatype_expl as row start invisible,
  row_end $sys_datatype_expl as row end invisible,
  period for system_time (row_start, row_end)
) with system versioning;
insert into t values (1, 0);
insert into t values (2, 0);
delete from t where a = 2;
--replace_result $ALTER_TYPE ALTER_TYPE
eval alter table t drop column b, $ALTER_TYPE;
--replace_result $ALTER_TYPE ALTER_TYPE
eval alter table t add index idx(a), $ALTER_TYPE;

select a, check_row(row_start, row_end) from t for system_time all order by a;

--echo # MDEV-17038 ALTER TABLE CHANGE COLUMN c1 c1 bigint NOT NULL -
--echo # generates error if table uses SYSTEM VERSIONING [tempesta-tech/mariadb#540]
create or replace table t1 (a int, key(a)) with system versioning;
create or replace table t2 like t;
alter table t2 add foreign key(a) references t1(a);
--replace_result $ALTER_TYPE ALTER_TYPE
eval alter table t2 modify column a int not null, $ALTER_TYPE;

drop database test;
create database test;
