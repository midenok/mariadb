set default_storage_engine=innodb;
set @bigval= repeat('0123456789', 30);
create or replace procedure check_table(table_name varchar(255))
begin
select table_id into @table_id
from information_schema.innodb_sys_tables
where name = concat('test/', table_name);
select name, mtype, hex(prtype) as prtype, len
from information_schema.innodb_sys_columns
where table_id = @table_id;
end~~
# Case 1: VARCHAR(<255) -> VARCHAR(>255) conversion
create or replace table t (a varchar(2)) row_format=redundant;
alter table t modify a varchar(300);
insert into t values (@bigval);
select count(a) from t where a = @bigval;
count(a)
1
insert into t values (repeat('X', 301));
ERROR 22001: Data too long for column 'a' at row 1
alter table t modify a char(4096);
select count(a) from t where a = @bigval;
count(a)
1
check table t extended;
Table	Op	Msg_type	Msg_text
test.t	check	status	OK
call check_table('t');
name	mtype	prtype	len
a	2	800FE	4096
# Case 2: CHAR extension
create or replace table t (a char(256)) engine=myisam;
ERROR 42000: Column length too big for column 'a' (max = 255); use BLOB or TEXT instead
create or replace table t (a char(256)) engine=myisam row_format=redundant;
ERROR 42000: Column length too big for column 'a' (max = 255); use BLOB or TEXT instead
create or replace table t (a char(256));
ERROR 42000: Column length too big for column 'a' (max = 255); use BLOB or TEXT instead
create or replace table t (a char(256)) row_format=redundant;
create or replace table t (a char(2)) row_format=redundant;
alter table t modify a char(300);
insert into t values (@bigval);
select count(a) from t where a = @bigval;
count(a)
1
alter table t modify a char(4096);
select count(a) from t where a = @bigval;
count(a)
1
check table t extended;
Table	Op	Msg_type	Msg_text
test.t	check	status	OK
call check_table('t');
name	mtype	prtype	len
a	2	800FE	4096
# Case 3: VARCHAR -> CHAR conversion
create or replace table t (a varchar(300)) row_format=redundant;
insert into t values (@bigval);
alter table t modify a char(300);
select count(a) from t where a = @bigval;
count(a)
1
check table t extended;
Table	Op	Msg_type	Msg_text
test.t	check	status	OK
call check_table('t');
name	mtype	prtype	len
a	2	800FE	300
create or replace table t (a varchar(300)) row_format=redundant;
alter table t modify a char(259);
# Case 4: integer conversions
create or replace table t (x tinyint) row_format=redundant;
insert into t values (127);
alter table t modify x smallint;
select * from t;
x
127
check table t extended;
Table	Op	Msg_type	Msg_text
test.t	check	status	OK
call check_table('t');
name	mtype	prtype	len
x	6	402	2
update t set x= 32767;
alter table t modify x mediumint;
select * from t;
x
32767
check table t extended;
Table	Op	Msg_type	Msg_text
test.t	check	status	OK
call check_table('t');
name	mtype	prtype	len
x	6	409	3
update t set x= 8388607;
alter table t modify x int;
select * from t;
x
8388607
check table t extended;
Table	Op	Msg_type	Msg_text
test.t	check	status	OK
call check_table('t');
name	mtype	prtype	len
x	6	403	4
update t set x= 2147483647;
alter table t modify x bigint;
select * from t;
x
2147483647
check table t extended;
Table	Op	Msg_type	Msg_text
test.t	check	status	OK
call check_table('t');
name	mtype	prtype	len
x	6	408	8
# Case 5: instant conversion CHAR -> VARCHAR
create or replace table t(a char(2));
insert into t values('a ');
select hex(a) from t;
hex(a)
61
alter table t change a a varchar(2);
select hex(a) from t;
hex(a)
61
drop table t;
# Check assertion in wrong instant operation
create or replace table t1 (a varchar(26) not null) default character set utf8mb4 row_format=redundant;
alter table t1 modify a varchar(25) not null;
drop database test;
create database test;
