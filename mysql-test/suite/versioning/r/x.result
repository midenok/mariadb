create or replace table t1 (x int) with system versioning
partition by system_time limit 999 auto_increment;
ERROR HY000: Wrong parameters for partitioned `t1`: wrong value for LIMIT (< 1000)
create or replace table t1 (x int) with system versioning
partition by system_time interval 3599 second auto_increment;
ERROR HY000: Wrong parameters for partitioned `t1`: wrong value for INTERVAL (< 1 HOUR)
create or replace table t1 (x int) with system versioning
partition by system_time limit 1000 auto_increment;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME LIMIT 1000 AUTO_INCREMENT
PARTITIONS 2
insert into t1 values (1);
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME LIMIT 1000 AUTO_INCREMENT
PARTITIONS 3
# Increment from 2 to 5
create or replace table t1 (x int) with system versioning
partition by system_time interval 3600 second
starts '2000-01-01 00:00:00' auto_increment;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 3600 SECOND STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
PARTITIONS 2
set timestamp= unix_timestamp('2000-01-01 00:00:00');
insert into t1 values (1);
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 3600 SECOND STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
PARTITIONS 3
set timestamp= unix_timestamp('2000-01-01 01:00:00');
update t1 set x= x + 1;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 3600 SECOND STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
PARTITIONS 4
set timestamp= unix_timestamp('2000-01-01 02:00:00');
update t1 set x= x + 2;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 3600 SECOND STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
PARTITIONS 5
# Increment from 3 to 6, manual names, LOCK TABLES
set timestamp= unix_timestamp('2000-01-01 00:00:00');
create or replace table t1 (x int) with system versioning
partition by system_time interval 1 hour auto_increment (
partition p1 history,
partition p3 history,
partition pn current);
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
(PARTITION `p1` HISTORY ENGINE = MyISAM,
 PARTITION `p3` HISTORY ENGINE = MyISAM,
 PARTITION `pn` CURRENT ENGINE = MyISAM)
insert into t1 values (1);
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
(PARTITION `p1` HISTORY ENGINE = MyISAM,
 PARTITION `p3` HISTORY ENGINE = MyISAM,
 PARTITION `pn` CURRENT ENGINE = MyISAM)
set timestamp= unix_timestamp('2000-01-01 01:00:00');
update t1 set x= x + 3;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
(PARTITION `p1` HISTORY ENGINE = MyISAM,
 PARTITION `p3` HISTORY ENGINE = MyISAM,
 PARTITION `p2` HISTORY ENGINE = MyISAM,
 PARTITION `pn` CURRENT ENGINE = MyISAM)
set timestamp= unix_timestamp('2000-01-01 02:00:00');
update t1 set x= x + 4;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
(PARTITION `p1` HISTORY ENGINE = MyISAM,
 PARTITION `p3` HISTORY ENGINE = MyISAM,
 PARTITION `p2` HISTORY ENGINE = MyISAM,
 PARTITION `p4` HISTORY ENGINE = MyISAM,
 PARTITION `pn` CURRENT ENGINE = MyISAM)
lock tables t1 write;
set timestamp= unix_timestamp('2000-01-01 03:00:00');
update t1 set x= x + 5;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
(PARTITION `p1` HISTORY ENGINE = MyISAM,
 PARTITION `p3` HISTORY ENGINE = MyISAM,
 PARTITION `p2` HISTORY ENGINE = MyISAM,
 PARTITION `p4` HISTORY ENGINE = MyISAM,
 PARTITION `p5` HISTORY ENGINE = MyISAM,
 PARTITION `pn` CURRENT ENGINE = MyISAM)
unlock tables;
# Test VIEW, LOCK TABLES
set timestamp= unix_timestamp('2000-01-01 00:00:00');
create or replace table t1 (x int) with system versioning
partition by system_time interval 1 hour auto_increment;
create or replace view v1 as select * from t1;
insert into v1 values (1);
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
PARTITIONS 3
lock tables t1 write;
set timestamp= unix_timestamp('2000-01-01 01:00:00');
update t1 set x= x + 3;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
PARTITIONS 4
unlock tables;
drop view v1;
drop tables t1;
# Multiple increments in single command
set timestamp= unix_timestamp('2000-01-01 00:00:00');
create or replace table t1 (x int) with system versioning
partition by system_time interval 1 hour auto_increment partitions 3;
create or replace table t2 (y int) with system versioning
partition by system_time interval 1 hour auto_increment partitions 4;
insert into t1 values (1);
insert into t2 values (2);
set timestamp= unix_timestamp('2000-01-01 01:00:00');
update t1, t2 set x= x + 1, y= y + 1;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
PARTITIONS 4
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
PARTITIONS 4
set timestamp= unix_timestamp('2000-01-01 02:00:00');
update t1, t2 set x= x + 1, y= y + 1;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
PARTITIONS 5
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
PARTITIONS 5
drop tables t1, t2;
# PS, SP, LOCK TABLES
set timestamp= unix_timestamp('2000-01-01 00:00:00');
create or replace table t1 (x int) with system versioning
partition by system_time interval 1 hour auto_increment;
execute immediate 'insert into t1 values (1)';
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
PARTITIONS 3
prepare s from 'update t1 set x= x + 6';
set timestamp= unix_timestamp('2000-01-01 01:00:00');
execute s;
execute s;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
PARTITIONS 4
lock tables t1 write;
set timestamp= unix_timestamp('2000-01-01 02:00:00');
execute s;
execute s;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
PARTITIONS 5
unlock tables;
drop prepare s;
create procedure sp() update t1 set x= x + 7;
set timestamp= unix_timestamp('2000-01-01 03:00:00');
call sp;
call sp;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
PARTITIONS 6
lock tables t1 write;
set timestamp= unix_timestamp('2000-01-01 04:00:00');
call sp;
call sp;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
PARTITIONS 7
unlock tables;
drop procedure sp;
# Complex table
set timestamp= unix_timestamp('2000-01-01 00:00:00');
create or replace table t1 (
x int primary key auto_increment,
t timestamp(6) default '2001-11-11 11:11:11',
b blob(4096) compressed null,
c varchar(1033) character set utf8 not null,
u int unique,
m enum('a', 'b', 'c') not null default 'a' comment 'absolute',
i1 tinyint, i2 smallint, i3 bigint,
index three(i1, i2, i3),
v1 timestamp(6) generated always as (t + interval 1 day),
v2 timestamp(6) generated always as (t + interval 1 month) stored,
s timestamp(6) as row start,
e timestamp(6) as row end,
period for system_time (s, e),
ps date, pe date,
period for app_time (ps, pe),
constraint check_constr check (u > -1))
with system versioning default charset=ucs2
partition by system_time interval 1 hour auto_increment (
partition p2 history,
partition pn current);
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) NOT NULL AUTO_INCREMENT,
  `t` timestamp(6) NOT NULL DEFAULT '2001-11-11 11:11:11.000000',
  `b` blob /*!100301 COMPRESSED*/ DEFAULT NULL,
  `c` varchar(1033) CHARACTER SET utf8 NOT NULL,
  `u` int(11) DEFAULT NULL,
  `m` enum('a','b','c') NOT NULL DEFAULT 'a' COMMENT 'absolute',
  `i1` tinyint(4) DEFAULT NULL,
  `i2` smallint(6) DEFAULT NULL,
  `i3` bigint(20) DEFAULT NULL,
  `v1` timestamp(6) GENERATED ALWAYS AS (`t` + interval 1 day) VIRTUAL,
  `v2` timestamp(6) GENERATED ALWAYS AS (`t` + interval 1 month) STORED,
  `s` timestamp(6) GENERATED ALWAYS AS ROW START,
  `e` timestamp(6) GENERATED ALWAYS AS ROW END,
  `ps` date NOT NULL,
  `pe` date NOT NULL,
  PRIMARY KEY (`x`,`e`),
  UNIQUE KEY `u` (`u`,`e`),
  KEY `three` (`i1`,`i2`,`i3`),
  PERIOD FOR SYSTEM_TIME (`s`, `e`),
  PERIOD FOR `app_time` (`ps`, `pe`),
  CONSTRAINT `check_constr` CHECK (`u` > -1)
) ENGINE=MyISAM DEFAULT CHARSET=ucs2 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
(PARTITION `p2` HISTORY ENGINE = MyISAM,
 PARTITION `pn` CURRENT ENGINE = MyISAM)
insert into t1 (x, c, u, i1, i2, i3, ps, pe)
values (1, 'cc', 0, 1, 2, 3, '1999-01-01', '2000-01-01');
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) NOT NULL AUTO_INCREMENT,
  `t` timestamp(6) NOT NULL DEFAULT '2001-11-11 11:11:11.000000',
  `b` blob /*!100301 COMPRESSED*/ DEFAULT NULL,
  `c` varchar(1033) CHARACTER SET utf8 NOT NULL,
  `u` int(11) DEFAULT NULL,
  `m` enum('a','b','c') NOT NULL DEFAULT 'a' COMMENT 'absolute',
  `i1` tinyint(4) DEFAULT NULL,
  `i2` smallint(6) DEFAULT NULL,
  `i3` bigint(20) DEFAULT NULL,
  `v1` timestamp(6) GENERATED ALWAYS AS (`t` + interval 1 day) VIRTUAL,
  `v2` timestamp(6) GENERATED ALWAYS AS (`t` + interval 1 month) STORED,
  `s` timestamp(6) GENERATED ALWAYS AS ROW START,
  `e` timestamp(6) GENERATED ALWAYS AS ROW END,
  `ps` date NOT NULL,
  `pe` date NOT NULL,
  PRIMARY KEY (`x`,`e`),
  UNIQUE KEY `u` (`u`,`e`),
  KEY `three` (`i1`,`i2`,`i3`),
  PERIOD FOR SYSTEM_TIME (`s`, `e`),
  PERIOD FOR `app_time` (`ps`, `pe`),
  CONSTRAINT `check_constr` CHECK (`u` > -1)
) ENGINE=MyISAM AUTO_INCREMENT=2 DEFAULT CHARSET=ucs2 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
(PARTITION `p2` HISTORY ENGINE = MyISAM,
 PARTITION `p1` HISTORY ENGINE = MyISAM,
 PARTITION `pn` CURRENT ENGINE = MyISAM)
set timestamp= unix_timestamp('2000-01-01 01:00:00');
update t1 set x= x + 8;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) NOT NULL AUTO_INCREMENT,
  `t` timestamp(6) NOT NULL DEFAULT '2001-11-11 11:11:11.000000',
  `b` blob /*!100301 COMPRESSED*/ DEFAULT NULL,
  `c` varchar(1033) CHARACTER SET utf8 NOT NULL,
  `u` int(11) DEFAULT NULL,
  `m` enum('a','b','c') NOT NULL DEFAULT 'a' COMMENT 'absolute',
  `i1` tinyint(4) DEFAULT NULL,
  `i2` smallint(6) DEFAULT NULL,
  `i3` bigint(20) DEFAULT NULL,
  `v1` timestamp(6) GENERATED ALWAYS AS (`t` + interval 1 day) VIRTUAL,
  `v2` timestamp(6) GENERATED ALWAYS AS (`t` + interval 1 month) STORED,
  `s` timestamp(6) GENERATED ALWAYS AS ROW START,
  `e` timestamp(6) GENERATED ALWAYS AS ROW END,
  `ps` date NOT NULL,
  `pe` date NOT NULL,
  PRIMARY KEY (`x`,`e`),
  UNIQUE KEY `u` (`u`,`e`),
  KEY `three` (`i1`,`i2`,`i3`),
  PERIOD FOR SYSTEM_TIME (`s`, `e`),
  PERIOD FOR `app_time` (`ps`, `pe`),
  CONSTRAINT `check_constr` CHECK (`u` > -1)
) ENGINE=MyISAM AUTO_INCREMENT=10 DEFAULT CHARSET=ucs2 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
(PARTITION `p2` HISTORY ENGINE = MyISAM,
 PARTITION `p1` HISTORY ENGINE = MyISAM,
 PARTITION `p3` HISTORY ENGINE = MyISAM,
 PARTITION `pn` CURRENT ENGINE = MyISAM)
# Concurrent DML
set timestamp= unix_timestamp('2000-01-01 00:00:00');
create or replace table t1 (x int) with system versioning
partition by system_time interval 1 hour auto_increment;
insert into t1 values (1);
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
PARTITIONS 3
connect con8, localhost, root;
connect con7, localhost, root;
connect con6, localhost, root;
connect con5, localhost, root;
connect con4, localhost, root;
connect con3, localhost, root;
connect con2, localhost, root;
connect con1, localhost, root;
set timestamp= unix_timestamp('2000-01-01 01:00:00');
update t1 set x= x + 10;
connection con2;
set timestamp= unix_timestamp('2000-01-01 01:00:00');
update t1 set x= x + 20;
connection con3;
set timestamp= unix_timestamp('2000-01-01 01:00:00');
update t1 set x= x + 30;
connection con4;
set timestamp= unix_timestamp('2000-01-01 01:00:00');
update t1 set x= x + 40;
connection con5;
set timestamp= unix_timestamp('2000-01-01 01:00:00');
update t1 set x= x + 50;
connection con6;
set timestamp= unix_timestamp('2000-01-01 01:00:00');
update t1 set x= x + 60;
connection con7;
set timestamp= unix_timestamp('2000-01-01 01:00:00');
update t1 set x= x + 70;
connection con8;
set timestamp= unix_timestamp('2000-01-01 01:00:00');
update t1 set x= x + 80;
connection con1;
disconnect con1;
connection con2;
disconnect con2;
connection con3;
disconnect con3;
connection con4;
disconnect con4;
connection con5;
disconnect con5;
connection con6;
disconnect con6;
connection con7;
disconnect con7;
disconnect con8;
connection default;
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `x` int(11) DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=latin1 WITH SYSTEM VERSIONING
 PARTITION BY SYSTEM_TIME INTERVAL 1 HOUR STARTS TIMESTAMP'2000-01-01 00:00:00' AUTO_INCREMENT
PARTITIONS 4
drop tables t1;
