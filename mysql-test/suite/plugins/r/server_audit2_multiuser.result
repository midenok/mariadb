CREATE TABLE IF NOT EXISTS mysql.server_audit_filters (
filtername char(80) COLLATE utf8_bin NOT NULL DEFAULT '',
rule longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT 'true' CHECK (json_valid(rule)),
CONSTRAINT c_filtername UNIQUE (filtername)
) ENGINE=Aria;
CREATE TABLE IF NOT EXISTS mysql.server_audit_users (host char(60) COLLATE utf8_bin NOT NULL DEFAULT '',
user char(80) COLLATE utf8_bin NOT NULL DEFAULT '',
filtername char(80) NOT NULL DEFAULT '',
CONSTRAINT c_host_user UNIQUE (host, user)
) ENGINE=Aria;
install plugin server_audit soname 'server_audit2';
show variables like 'server_audit%';
Variable_name	Value
server_audit_file_path	server_audit.log
server_audit_file_rotate_now	OFF
server_audit_file_rotate_size	1000000
server_audit_file_rotations	9
server_audit_logging	OFF
server_audit_mode	0
server_audit_output_type	file
server_audit_query_log_limit	1024
server_audit_reload_filters	OFF
server_audit_syslog_facility	LOG_USER
server_audit_syslog_ident	mysql-server_auditing
server_audit_syslog_info	
server_audit_syslog_priority	LOG_INFO
SET GLOBAL server_audit_logging=on;
INSERT INTO mysql.server_audit_filters VALUES ('default','{}');
INSERT INTO mysql.server_audit_filters VALUES ('user1','{"connect_event":"all","table_event":"ALL"}');
INSERT INTO mysql.server_audit_filters VALUES ('user2','{"connect_event":"all","query_event":"DDL"}');
INSERT INTO mysql.server_audit_filters VALUES ('user3','{"connect_event":"all","query_event":"DML"}');
INSERT INTO mysql.server_audit_users VALUES ('%','user1','user1');
INSERT INTO mysql.server_audit_users VALUES ('%','user2','user2');
INSERT INTO mysql.server_audit_users VALUES ('%','user3','user3');
CREATE USER 'user1'@'%';
CREATE USER 'user2'@'%';
CREATE USER 'user3'@'%';
GRANT all on *.* to 'user1'@'%';
GRANT all on *.* to 'user2'@'%';
GRANT all on *.* to 'user3'@'%';
connect  conn1,localhost,user1,,;
connect  conn2,localhost,user2,,;
connect  conn3,localhost,user3,,;
connection conn1;
SHOW STATUS LIKE "Server_audit_session_filter";
Variable_name	Value
Server_audit_session_filter	no filter
SET GLOBAL server_audit_reload_filters=ON;
CREATE DATABASE d1;
CREATE TABLE d1.t1 (id int);
INSERT INTO d1.t1 VALUES (1);
UPDATE d1.t1 SET id=2;
DELETE FROM d1.t1;
DROP TABLE d1.t1;
DROP DATABASE d1;
connection conn2;
SHOW STATUS LIKE "Server_audit_session_filter";
Variable_name	Value
Server_audit_session_filter	user2
SET GLOBAL server_audit_reload_filters=ON;
CREATE DATABASE d1;
CREATE TABLE d1.t1 (id int);
INSERT INTO d1.t1 VALUES (1);
UPDATE d1.t1 SET id=2;
DELETE FROM d1.t1;
DROP TABLE d1.t1;
DROP DATABASE d1;
connection conn3;
SHOW STATUS LIKE "Server_audit_session_filter";
Variable_name	Value
Server_audit_session_filter	user3
SET GLOBAL server_audit_reload_filters=ON;
CREATE DATABASE d1;
CREATE TABLE d1.t1 (id int);
INSERT INTO d1.t1 VALUES (1);
UPDATE d1.t1 SET id=2;
DELETE FROM d1.t1;
DROP TABLE d1.t1;
DROP DATABASE d1;
connection default;
disconnect conn1;
disconnect conn2;
disconnect conn3;
DROP USER 'user1'@'%';
DROP USER 'user2'@'%';
DROP USER 'user3'@'%';
uninstall plugin server_audit;
Warnings:
Warning	1620	Plugin is busy and will be uninstalled on shutdown
truncate mysql.server_audit_filters;
truncate mysql.server_audit_users;
TIME,HOSTNAME,,,0,0,AUDIT_CONFIG,,file_path=server_audit.log,0
TIME,HOSTNAME,,,0,0,AUDIT_CONFIG,,rotate_size=1000000,0
TIME,HOSTNAME,,,0,0,AUDIT_CONFIG,,file_rotations=9,0
TIME,HOSTNAME,root,localhost,ID,0,AUDIT_CONFIG,test,logging=ON,0
TIME,HOSTNAME,root,localhost,ID,ID,QUERY,test,'SET GLOBAL server_audit_logging=on',0
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,server_audit_filters,
TIME,HOSTNAME,root,localhost,ID,ID,QUERY,test,'INSERT INTO mysql.server_audit_filters VALUES (\'default\',\'{}\')',0
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,server_audit_filters,
TIME,HOSTNAME,root,localhost,ID,ID,QUERY,test,'INSERT INTO mysql.server_audit_filters VALUES (\'user1\',\'{"connect_event":"all","table_event":"ALL"}\')',0
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,server_audit_filters,
TIME,HOSTNAME,root,localhost,ID,ID,QUERY,test,'INSERT INTO mysql.server_audit_filters VALUES (\'user2\',\'{"connect_event":"all","query_event":"DDL"}\')',0
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,server_audit_filters,
TIME,HOSTNAME,root,localhost,ID,ID,QUERY,test,'INSERT INTO mysql.server_audit_filters VALUES (\'user3\',\'{"connect_event":"all","query_event":"DML"}\')',0
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,server_audit_users,
TIME,HOSTNAME,root,localhost,ID,ID,QUERY,test,'INSERT INTO mysql.server_audit_users VALUES (\'%\',\'user1\',\'user1\')',0
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,server_audit_users,
TIME,HOSTNAME,root,localhost,ID,ID,QUERY,test,'INSERT INTO mysql.server_audit_users VALUES (\'%\',\'user2\',\'user2\')',0
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,server_audit_users,
TIME,HOSTNAME,root,localhost,ID,ID,QUERY,test,'INSERT INTO mysql.server_audit_users VALUES (\'%\',\'user3\',\'user3\')',0
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,db,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,tables_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,columns_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,procs_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,proxies_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,roles_mapping,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,global_priv,
TIME,HOSTNAME,root,localhost,ID,ID,QUERY,test,'CREATE USER \'user1\'@\'%\'',0
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,db,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,tables_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,columns_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,procs_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,proxies_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,roles_mapping,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,global_priv,
TIME,HOSTNAME,root,localhost,ID,ID,QUERY,test,'CREATE USER \'user2\'@\'%\'',0
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,db,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,tables_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,columns_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,procs_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,proxies_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,roles_mapping,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,global_priv,
TIME,HOSTNAME,root,localhost,ID,ID,QUERY,test,'CREATE USER \'user3\'@\'%\'',0
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,db,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,global_priv,
TIME,HOSTNAME,root,localhost,ID,ID,QUERY,test,'GRANT all on *.* to \'user1\'@\'%\'',0
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,db,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,global_priv,
TIME,HOSTNAME,root,localhost,ID,ID,QUERY,test,'GRANT all on *.* to \'user2\'@\'%\'',0
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,db,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,global_priv,
TIME,HOSTNAME,root,localhost,ID,ID,QUERY,test,'GRANT all on *.* to \'user3\'@\'%\'',0
TIME,HOSTNAME,user1,localhost,ID,0,CONNECT,test,,0
TIME,HOSTNAME,user2,localhost,ID,0,CONNECT,test,,0
TIME,HOSTNAME,user3,localhost,ID,0,CONNECT,test,,0
TIME,HOSTNAME,user1,localhost,ID,ID,QUERY,test,'SHOW STATUS LIKE "Server_audit_session_filter"',0
TIME,HOSTNAME,user1,localhost,ID,0,AUDIT_CONFIG,test,reload_filters=ON,0
TIME,HOSTNAME,user1,localhost,ID,ID,CREATE,d1,t1,
TIME,HOSTNAME,user1,localhost,ID,ID,WRITE,d1,t1,
TIME,HOSTNAME,user1,localhost,ID,ID,READ,mysql,table_stats,
TIME,HOSTNAME,user1,localhost,ID,ID,READ,mysql,column_stats,
TIME,HOSTNAME,user1,localhost,ID,ID,READ,mysql,index_stats,
TIME,HOSTNAME,user1,localhost,ID,ID,WRITE,d1,t1,
TIME,HOSTNAME,user1,localhost,ID,ID,WRITE,d1,t1,
TIME,HOSTNAME,user1,localhost,ID,ID,WRITE,mysql,table_stats,
TIME,HOSTNAME,user1,localhost,ID,ID,WRITE,mysql,column_stats,
TIME,HOSTNAME,user1,localhost,ID,ID,WRITE,mysql,index_stats,
TIME,HOSTNAME,user1,localhost,ID,ID,DROP,d1,t1,
TIME,HOSTNAME,user1,localhost,ID,ID,READ,mysql,proc,
TIME,HOSTNAME,user1,localhost,ID,ID,WRITE,mysql,proc,
TIME,HOSTNAME,user1,localhost,ID,ID,WRITE,mysql,event,
TIME,HOSTNAME,user2,localhost,ID,0,AUDIT_CONFIG,test,reload_filters=ON,0
TIME,HOSTNAME,user2,localhost,ID,ID,QUERY,test,'CREATE DATABASE d1',0
TIME,HOSTNAME,user2,localhost,ID,ID,QUERY,test,'CREATE TABLE d1.t1 (id int)',0
TIME,HOSTNAME,user2,localhost,ID,ID,QUERY,test,'DROP TABLE d1.t1',0
TIME,HOSTNAME,user2,localhost,ID,ID,QUERY,test,'DROP DATABASE d1',0
TIME,HOSTNAME,user3,localhost,ID,0,AUDIT_CONFIG,test,reload_filters=ON,0
TIME,HOSTNAME,user3,localhost,ID,ID,QUERY,test,'INSERT INTO d1.t1 VALUES (1)',0
TIME,HOSTNAME,user3,localhost,ID,ID,QUERY,test,'UPDATE d1.t1 SET id=2',0
TIME,HOSTNAME,user3,localhost,ID,ID,QUERY,test,'DELETE FROM d1.t1',0
TIME,HOSTNAME,user1,localhost,ID,0,DISCONNECT,test,,0
TIME,HOSTNAME,user2,localhost,ID,0,DISCONNECT,test,,0
TIME,HOSTNAME,user3,localhost,ID,0,DISCONNECT,test,,0
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,db,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,tables_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,columns_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,procs_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,proxies_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,roles_mapping,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,global_priv,
TIME,HOSTNAME,root,localhost,ID,ID,QUERY,test,'DROP USER \'user1\'@\'%\'',0
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,db,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,tables_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,columns_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,procs_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,proxies_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,roles_mapping,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,global_priv,
TIME,HOSTNAME,root,localhost,ID,ID,QUERY,test,'DROP USER \'user2\'@\'%\'',0
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,db,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,tables_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,columns_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,procs_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,proxies_priv,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,roles_mapping,
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,global_priv,
TIME,HOSTNAME,root,localhost,ID,ID,QUERY,test,'DROP USER \'user3\'@\'%\'',0
TIME,HOSTNAME,root,localhost,ID,ID,WRITE,mysql,plugin,
TIME,HOSTNAME,root,localhost,ID,ID,QUERY,test,'uninstall plugin server_audit',0
