
steps:

  - bash: |
      set -x

      uname -a
      INSTALLED=""

      if [[ -e /etc/redhat-release ]]; then
        cat /etc/*release
        INSTALLED=$(rpm -qa | grep -iE "^maria|^mysql|^percona|^galera" ||:)
        [[ -n "${INSTALLED}" ]] && sudo yum -y erase ${INSTALLED} ||:
        sudo yum -y upgrade
        #MENT-292
        sudo yum -y install patch
      fi

      if [[ -e /etc/SuSE-release ]]; then
        cat /etc/*release
        INSTALLED=$(rpm -qa | grep -iE "^maria|^mysql|^percona|^galera" ||:)
        [[ -n "${INSTALLED}" ]] && sudo zypper -n remove ${INSTALLED} ||:
      fi

      if [[ -e /etc/debian_version ]]; then
        cat /etc/*_version
        sudo bash -c "rm -fv ${DEB_LOCAL_LIST}"
        export DEBIAN_FRONTEND=noninteractive
        sudo apt update
        sudo apt-get -y install debconf-utils
        INSTALLED=$(dpkg -l | awk '{print $2}' | grep -iE "^maria|^mysql|^percona|^galera"  ||:)
        if [[ -n "${INSTALLED}" ]]; then
          echo mariadb-server-10.1  mariadb-server-10.1/postrm_remove_databases  boolean false | sudo debconf-set-selections
          echo mariadb-server-10.2  mariadb-server-10.2/postrm_remove_databases  boolean false | sudo debconf-set-selections
          echo mariadb-server-10.3  mariadb-server-10.3/postrm_remove_databases  boolean false | sudo debconf-set-selections
          echo mariadb-server-10.4  mariadb-server-10.4/postrm_remove_databases  boolean false | sudo debconf-set-selections
          sudo apt-get -y -f purge ${INSTALLED} ||:
        fi
        sudo apt-get -y -f autoremove
        sudo apt-get -y -f -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" dist-upgrade
        sudo apt-get -y -f install debconf-utils dpkg-dev zlib1g-dev
        #MENT-292
        sudo apt-get -y -f install patch
      fi

      [[ -n "$(pidof mysqld)" ]] && sudo pkill -9 mysqld
      sudo rm -frv /var/lib/mysql /usr/share/mysql* /etc/my.cnf* /etc/mysql*
      sudo userdel bombalurina ||:
      sudo rm -frv /dev/shm/var*
      sudo rm -frv ${MYSQL_VARDIR}
      sudo rm -fv ${TEST_RESULTS_FILE}
    displayName: "Prepare VM for installation"
