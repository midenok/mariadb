steps:

  - bash: |
      set -x
      cd $(Build.SourcesDirectory)
      if [[ -d mysql-test ]]; then
        MYSQLTEST=$(Build.SourcesDirectory)/mysql-test
      else
        MYSQLTEST=$(find /usr/share -type d -name 'mysql-test' ||:)
      fi

      if [[ -z "${MYSQLTEST}" ]]; then
        echo "- mysql-test directory doesn't exist after PKG installation!"
        exit 1
      else
        sudo chown -R ${USER} "${MYSQLTEST}"
      fi

      cd "${MYSQLTEST}"
      exec perl mysql-test-run.pl --force --retry=3 --max-save-core=1 --vardir=${MYSQL_VARDIR} \
            --max-save-datadir=1 --max-test-fail=20 --big-test --parallel=auto
    displayName: "MTR -big test"
    condition: succeededOrFailed()

  - bash: |
      set -x
      cd $(Build.SourcesDirectory)
      if [[ -d mysql-test ]]; then
        MYSQLTEST=$(Build.SourcesDirectory)/mysql-test
      else
        MYSQLTEST=$(find /usr/share -type d -name 'mysql-test' ||:)
      fi

      if [[ -z "${MYSQLTEST}" ]]; then
        echo "- mysql-test directory doesn't exist after PKG installation!"
        exit 1
      else
        sudo chown -R ${USER} "${MYSQLTEST}"
      fi

      WSREP_PROVIDER=$(sudo find /usr -type f -name 'libgalera_enterprise_smm.so')

      if [[ -z ${WSREP_PROVIDER} ]]; then
        echo "- Galera Enterprise library doesn't exist after PKG installation!"
        exit 1
      else
        export WSREP_PROVIDER
      fi
      [[ -d bin ]] && export PATH="$(Build.SourcesDirectory)/bin:${PATH}"
      sudo mysqld --help --verbose 2>&1 | grep wsrep
      sudo mysql -e 'show status like "wsrep%%"'


      cd "${MYSQLTEST}"

      perl mysql-test-run.pl --force --parallel=auto --suite=galera,galera_sr,wsrep \
        --max-test-fail=0 --testcase-timeout=120 --vardir=${MYSQL_VARDIR}

    displayName: "Galera test"
    failOnStderr: false
    condition: succeededOrFailed()

  - bash: |
      set -x
      cd $(Build.SourcesDirectory)
      if [[ -d mysql-test ]]; then
        MYSQLTEST=$(Build.SourcesDirectory)/mysql-test
      else
        MYSQLTEST=$(find /usr/share -type d -name 'mysql-test' ||:)
      fi

      if [[ -z "${MYSQLTEST}" ]]; then
        echo "- mysql-test directory doesn't exist after PKG installation!"
        exit 1
      else
        sudo chown -R ${USER} "${MYSQLTEST}"
      fi

      cd "${MYSQLTEST}"
      perl mysql-test-run.pl --verbose-restart --force --retry=3 --max-save-core=0 --max-save-datadir=1 --mem --parallel=4
    displayName: "MTR Normal Test"
    failOnStderr: false
    condition: succeededOrFailed()

  - bash: |
      set -x
      cd $(Build.SourcesDirectory)
      if [[ -d mysql-test ]]; then
        MYSQLTEST=$(Build.SourcesDirectory)/mysql-test
      else
        MYSQLTEST=$(find /usr/share -type d -name 'mysql-test' ||:)
      fi

      if [[ -z "${MYSQLTEST}" ]]; then
        echo "- mysql-test directory doesn't exist after PKG installation!"
        exit 1
      else
        sudo chown -R ${USER} "${MYSQLTEST}"
      fi
      cd "${MYSQLTEST}"
      perl mysql-test-run.pl  --verbose-restart --force --retry=3 --max-save-core=0 --max-save-datadir=1 --mem --parallel=4 --ps-protocol
    displayName: "MTR PS Protocol test"
    failOnStderr: false
    condition: succeededOrFailed()

  - bash: |
      set -x
      cd $(Build.SourcesDirectory)
      if [[ -d mysql-test ]]; then
        MYSQLTEST=$(Build.SourcesDirectory)/mysql-test
      else
        MYSQLTEST=$(find /usr/share -type d -name 'mysql-test' ||:)
      fi

      if [[ -z "${MYSQLTEST}" ]]; then
        echo "- mysql-test directory doesn't exist after PKG installation!"
        exit 1
      else
        sudo chown -R ${USER} "${MYSQLTEST}"
      fi
      cd "${MYSQLTEST}"
      perl mysql-test-run.pl  --verbose-restart --force --retry=3 --max-save-core=0 --max-save-datadir=1 --mem \
        --parallel=2 --suite=funcs_1,funcs_2,stress,jp --testcase-timeout=120 --mysqld=--open-files-limit=0 --mysqld=--log-warnings=1
    displayName: "MTR Extra test"
    failOnStderr: false
    condition: succeededOrFailed()

  - bash: |
      set -x
      cd $(Build.SourcesDirectory)
      if [[ -d mysql-test ]]; then
        MYSQLTEST=$(Build.SourcesDirectory)/mysql-test
      else
        MYSQLTEST=$(find /usr/share -type d -name 'mysql-test' ||:)
      fi

      if [[ -z "${MYSQLTEST}" ]]; then
        echo "- mysql-test directory doesn't exist after PKG installation!"
        exit 1
      else
        sudo chown -R ${USER} "${MYSQLTEST}"
      fi
      cd "${MYSQLTEST}"
      perl mysql-test-run.pl --verbose-restart --force --retry=3 --max-save-core=0 --max-save-datadir=1 --mem \
        --parallel=2 --suite=spider,spider/bg,engines/funcs,engines/iuds --testcase-timeout=120 --mysqld=--open-files-limit=0 \
        --mysqld=--log-warnings=1
    displayName: "MTR Engines test"
    failOnStderr: false
    condition: succeededOrFailed()
