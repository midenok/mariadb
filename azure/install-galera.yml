steps:

  - bash: |
      set -x

      if [[ -e /usr/bin/apt-get ]]; then
        sudo apt update
        sudo apt install -y software-properties-common dirmngr
        sudo apt-add-repository http://downloads.mariadb.com/galera-test/repo/deb
        sudo apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0xCE1A3DD5E3C94F49
        sudo apt update
        DEBIAN_FRONTEND=noninteractive sudo apt install -y galera-enterprise-4 galera-arbitrator-4 rsync netcat socat
      fi

      if [[ -e /usr/bin/yum ]]; then
        sudo sh -c "echo '[galera]' > /etc/yum.repos.d/galera.repo"
        sudo sh -c "echo 'name=galera' >> /etc/yum.repos.d/galera.repo"
        sudo sh -c "echo 'baseurl=http://downloads.mariadb.com/galera-test/repo/rpm/rhel/\$releasever/\$basearch/' >> /etc/yum.repos.d/galera.repo"
        sudo sh -c "echo 'gpgkey=https://downloads.mariadb.com/MariaDB/RPM-GPG-KEY-MariaDB-Ent' >> /etc/yum.repos.d/galera.repo"
        sudo sh -c "echo 'gpgcheck=1' >> /etc/yum.repos.d/galera.repo"
        sudo cat /etc/yum.repos.d/galera.repo
        sudo yum install -y galera-enterprise-4 rsync socat lsof
      fi

      if [[ -e /usr/bin/zypper ]]; then
        sudo zypper -n in wget || true
        RELEASE=$(grep VERSION /etc/SuSE-release | awk '{print $NF}')
        wget https://downloads.mariadb.com/MariaDB/RPM-GPG-KEY-MariaDB-Ent -O /tmp/rpm.key
        sudo rpm --import /tmp/rpm.key && rm -f /tmp/rpm.key
        sudo zypper rr Galera-Enterprise || true
        sudo zypper ar -f -g http://downloads.mariadb.com/galera-test/repo/rpm/sles/${RELEASE}/x86_64/ Galera-Enterprise
        sudo zypper -n in rsync socat lsof
      fi
    displayName: "Install Galera-Enterprise-4"
