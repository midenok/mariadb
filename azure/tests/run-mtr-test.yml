parameters:
  MtrArgs: ''
  TestName: 'MTR Test'

steps:

  - bash: |
      set -x
      cd $(Build.SourcesDirectory)
      [[ -d bin ]] && export PATH="$(Build.SourcesDirectory)/bin:${PATH}"

      WSREP_PROVIDER=$(sudo find /usr -type f -name 'libgalera_enterprise_smm.so')
      if [[ -n ${WSREP_PROVIDER} ]]; then
        export WSREP_PROVIDER
        sudo mysqld --help --verbose 2>&1 | grep wsrep
        sudo mysql -e 'show status like "wsrep%%"'
      fi

      if [[ -d mysql-test ]]; then
        MYSQLTEST=$(Build.SourcesDirectory)/mysql-test
      else
        MYSQLTEST=$(find /usr/share -type d -name 'mysql-test' ||:)
      fi

      if [[ -z "${MYSQLTEST}" ]]; then
        echo "- mysql-test directory doesn't exist after PKG installation!"
        exit 1
      else
        sudo chown -R ${USER} "${MYSQLTEST}"
      fi

      cd "${MYSQLTEST}"
      exec perl mysql-test-run.pl ${{ parameters.MtrArgs }}

    displayName: "MTR - ${{ parameters.TestName }}"
    condition: succeededOrFailed()
